---
title: 'Project 1: Exploratory Data Analysis'
author: "Karen Zhao kz3768"
date: '4/1/21'
output:
  html_document:
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
  pdf_document:
    toc: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, fig.align = "center", warning = F, message = F,
tidy=TRUE, tidy.opts=list(width.cutoff=60), R.options=list(max.print=100))
```
#### 0. Introduction (5  pts)

I chose to focus on amusement parks, specifically the injuries sustained by amusement park goers, for my project simply because I have always loved going to amusement parks. However, I never gave much thought to just how dangerous the rides were and how many people actually sustained severe injuries from them. The dataset I chose was provided by RPubs, and it provides a variety of details about the injuries sustained by amusement park goers at different amusement parks in Texas. I then started thinking about other variables that would be related to amusement park injuries, and the one I found most fitting was the median household income for each Texas city; I found this dataset on indexmundi.com. I then downloaded it as a csv file and uploaded it to R. I think I will find a negative correlation between the median household income of the city and the total number of amusement park injuries that occur at amusement parks in that city. I believe that the lower the median household income of the city, the less funds the city has to allocate towards entertainment and infrastructure. Therefore, the lower the quality and sturdiness of the amusement park rides and the higher the number of injuries sustained on them.

#### 1. Tidying: Rearranging Wide/Long (10 pts)

```{R}
library(tidyverse)
tx_injuries <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2019/2019-09-10/tx_injuries.csv")
library(readr)
txmedianhouseholdincome <- read.csv("tx median household income.csv")
```
*Both datasets were tidy, so pivot_wider and pivot_longer were not used in this part of the document.*

#### 2. Joining/Merging (10 pts)

```{R}
left_join(tx_injuries, txmedianhouseholdincome)
```
*I performed a left join because I wanted the median household income of each city to be listed along with the variables regarding the amusement park injuries that occurred in that city. There were no cases that were dropped.*

#### 3. Wrangling (40 pts)

```{R}
joined <- left_join(tx_injuries, txmedianhouseholdincome)
joined2 <- na.omit(joined)
joined2 %>% filter(city=="Austin") 
joined2 %>% arrange(value)
joined2 %>% select(contains("a"))
joined2 %>% mutate(ifelse(value > 60000, "high"))
joined2 %>% summarize(mean(age, na.rm=T), n(), n_distinct(city))
joined2 %>% group_by(ride_name, city) %>% summarize(mean_j = mean(age, na.rm=T), sd_j = sd(age, na.rm=T), n=n(), se_j=sd_j/sqrt(n))
joined2 %>% group_by(name_of_operation) %>% summarize(mean_j = mean(age, na.rm=T), sd_j = sd(age, na.rm=T), n=n(), se_j=sd_j/sqrt(n))
joined2 %>% group_by(injury_report_rec) %>% summarize(mean_j = mean(age, na.rm=T), sd_j = sd(age, na.rm=T), n=n(), se_j=sd_j/sqrt(n))
```
*The data was first filtered so that the only city whose data was shown was Austin. The data was then arranged in order of increasing value of median household income. The data was then selected to only show variables that started with the letter "a" (age and alleged_injury). The data was then mutated to categorize median household incomes above $60,000 as "high". Then summary statistics were computed for the variables. For the variable age, summarize() was used after grouping by ride_name and city. It was discovered that the cities with high median household incomes had fewer incidents of injuries sustained in amusement parks.*

#### 4. Visualizing (30 pts)

```{R}
joined2 %>% select_if(is.numeric) %>% cor %>% as.data.frame %>%  rownames_to_column %>% pivot_longer(-1) %>%  ggplot(aes(rowname,name,fill=value))+geom_tile()+  geom_text(aes(label=round(value,2)))+  xlab("")+ylab("")+coord_fixed()
joined2 %>% mutate(name_of_operation = factor(name_of_operation, levels = c("Splashtown","Skygroup","Schlitterbahn","Typhoon","Six Flag"))) %>% ggplot(aes(name_of_operation, fill = alleged_injury)) + geom_bar() + coord_flip() + labs(title = "Amusement Parks in Texas by Injuries", subtitle = "Most Common Types of Injuries",fill = "Type of Injuries", y = "Number of Injuries",x = "Amusement Parks")
ggplot(joined2, aes(x=value, y=injury_report_rec)) + geom_boxplot() + geom_jitter(alpha=0.5) + aes(color=value)
```
*In the first ggplot, it was shown that Six Flags has the highest number of injuries. In the second ggplot, the lowest median household income value had the highest number of injuries sustained, as predicted.* 

#### 5. Dimensionality Reduction (30 pts)

```{R}
joined3 <- joined2 %>% select(-value, -injury_report_rec, -age)
joined3 <- joined2 %>% select_if(is.numeric) %>% scale 
rownames(joined3) <- joined2$city
joined2_pca <- princomp(na.omit(joined3))
names(joined2_pca)
eigval <- joined2_pca$sdev^2 
varprop=round(eigval/sum(eigval),2)
ggplot() + geom_bar(aes(y=varprop, x=1:22), stat="identity") + geom_text(aes(x=1:22, y=varprop, label=round(varprop, 2)), vjust=1, col="white", size=5) + scale_y_continuous(breaks=seq(0, .6, .2), labels = scales::percent) + scale_x_continuous(breaks=1:10) + labs(title = "Proportion of Variance vs PCs", x = "Principle Component", y = "Variance Proportion")
prepareddata <- joined2 %>% ungroup() %>% select(-value, -injury_report_rec, -age)
nums <- prepareddata %>% select_if(is.numeric) %>% scale 
summary(joined2_pca, loadings=T)
```
*I took the joined2 dataset and cleaned the data by grabbing all numerics except value, injury_report_rec, and age. I then normalized the data and ran princomp() on the scaled data to see how many principal components to keep. I then squared to convert SDs to eigen values. I plotted the proportion of variance explained by each PC from greatest to least eigen values, picked PCs until the scree plot flattened, and picked PCs whose eigen values are greater than 1 to determine how many PCs to keep.*

```{r eval=F}
## paste this chunk into the ```{r setup} chunk at the top of your project 1 .Rmd file

knitr::opts_chunk$set(echo = TRUE, eval = TRUE, fig.align = "center", warning = F, message = F,
tidy=TRUE, tidy.opts=list(width.cutoff=60), R.options=list(max.print=100))
```
...
